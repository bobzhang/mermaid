///|
fn nfa_lock_options(use_ascii : Bool) -> @beautiful_mermaid.AsciiRenderOptions {
  { use_ascii, padding_x: 5, padding_y: 5, box_border_padding: 1 }
}

///|
fn inspect_nfa_ascii_and_unicode(input : String) -> String raise {
  let ascii = @beautiful_mermaid.render_mermaid_ascii(
    input,
    options=nfa_lock_options(true),
  )
  let unicode = @beautiful_mermaid.render_mermaid_ascii(
    input,
    options=nfa_lock_options(false),
  )
  (
    #|# ASCII
    #|
  ) +
  ascii +
  (
    #|
    #|
    #|# UNICODE
    #|
  ) +
  unicode
}

///|
test "NFA fixture 001: basic automaton with epsilon transitions" {
  let input =
    #|graph LR
    #|0@{shape: circ}
    #|1@{shape: circ}
    #|2@{shape: circ}
    #|3@{shape: circ}
    #|4@{shape: circ}
    #|5@{shape: circ}
    #|start@{shape: f-circ} --- 0
    #|0 -- [a-b] --> 3
    #|1 -- c --> 2
    #|2 -- d --> 4
    #|3 -.-> 1
    #|3 -.-> 4
    #|4 -.-> 0
    #|4 -.-> 5
    #|5 --- #0@{shape: dbl-circ}
  inspect(
    inspect_nfa_ascii_and_unicode(input),
    content=(
      #|# ASCII
      #|+---------------+        +---+     +---+      +---+     +-----------------+
      #||               |        |   |     |   |      |   |     |                 |
      #||  shape: circ  |--------| 0 |<--->| 4 |----->| 5 |---->| shape: dbl-circ |
      #||               |     |  |   |     |   |      |   |     |                 |
      #|+---------------+     |  +---+     +---+      +---+     +-----------------+
      #|        |             |    |                                               
      #|        |             |    |                                               
      #|        |             |    |                                               
      #|        |             |    |                                               
      #|        |             |    |                                               
      #|+---------------+     |  +---+     +---+                                   
      #||               |     |  |   |     |   |                                   
      #||  shape: circ  |     |  | 3 |---->| 1 |                                   
      #||               |     |  |   |     |   |                                   
      #|+---------------+     |  +---+     +---+                                   
      #|        |             |    ^                                               
      #|        |             |    |                                               
      #|        |             |    |                                               
      #|        |             |    |                                               
      #|        |             |    |                                               
      #|+---------------+     |  +---+                                             
      #||               |     |  |   |                                             
      #||  shape: circ  |     |  | 2 |                                             
      #||               |     |  |   |                                             
      #|+---------------+     |  +---+                                             
      #|        |             |    ^                                               
      #|        |             |    |                                               
      #|        |             |    |                                               
      #|        |             |    |                                               
      #|        |             |    |                                               
      #|+---------------+     |    |                                               
      #||               |     |    |                                               
      #||  shape: circ  |-----|    |                                               
      #||               |          |                                               
      #|+---------------+          |                                               
      #|        |                  |                                               
      #|        |                  |                                               
      #|        |                  |                                               
      #|        |                  |                                               
      #|        |                  |                                               
      #|+---------------+          |                                               
      #||               |          |                                               
      #||  shape: circ  |          |                                               
      #||               |          |                                               
      #|+---------------+          |                                               
      #|        |                  |                                               
      #|        |                  |                                               
      #|        |                  |                                               
      #|        |                  |                                               
      #|        |                  |                                               
      #|+---------------+          |                                               
      #||               |          |                                               
      #||  shape: circ  |          |                                               
      #||               |          |                                               
      #|+---------------+          |                                               
      #|        |                  |                                               
      #|        |                  |                                               
      #|        |                  |                                               
      #|        |                  |                                               
      #|        |                  |                                               
      #|+---------------+          |                                               
      #||               |          |                                               
      #|| shape: f-circ |          |                                               
      #||               |          |                                               
      #|+---------------+          |                                               
      #|        |                  |                                               
      #|        |                  |                                               
      #|        |                  |                                               
      #|        |                  |                                               
      #|        |                  |                                               
      #|+---------------+          |                                               
      #||               |          |                                               
      #||      a-b      |----------+                                               
      #||               |          |                                               
      #|+---------------+          |                                               
      #|        |                  |                                               
      #|        |                  |                                               
      #|        |                  |                                               
      #|        |                  |                                               
      #|        |                  |                                               
      #|+---------------+          |                                               
      #||               |          |                                               
      #||     1 -- c    |----------+                                               
      #||               |                                                          
      #|+---------------+                                                          
      #|        |                                                                  
      #|        |                                                                  
      #|        |                                                                  
      #|        |                                                                  
      #|        |                                                                  
      #|+---------------+                                                          
      #||               |                                                          
      #||     2 -- d    |                                                          
      #||               |                                                          
      #|+---------------+                                                          
      #|
      #|# UNICODE
      #|┌───────────────┐        ┌───┐     ┌───┐      ┌───┐     ┌─────────────────┐
      #|│               │        │   │     │   │      │   │     │                 │
      #|│  shape: circ  │─────┬──│ 0 │◄───►┤ 4 ├─────►│ 5 ├────►│ shape: dbl-circ │
      #|│               │     │  │   │     │   │      │   │     │                 │
      #|└───────────────┘     │  └───┘     └───┘      └───┘     └─────────────────┘
      #|        │             │    │                                               
      #|        │             │    │                                               
      #|        │             │    │                                               
      #|        │             │    │                                               
      #|        │             │    │                                               
      #|┌───────────────┐     │  ┌─┴─┐     ┌───┐                                   
      #|│               │     │  │   │     │   │                                   
      #|│  shape: circ  │     │  │ 3 ├────►│ 1 │                                   
      #|│               │     │  │   │     │   │                                   
      #|└───────────────┘     │  └───┘     └───┘                                   
      #|        │             │    ▲                                               
      #|        │             │    │                                               
      #|        │             │    │                                               
      #|        │             │    │                                               
      #|        │             │    │                                               
      #|┌───────────────┐     │  ┌───┐                                             
      #|│               │     │  │   │                                             
      #|│  shape: circ  │     │  │ 2 │                                             
      #|│               │     │  │   │                                             
      #|└───────────────┘     │  └───┘                                             
      #|        │             │    ▲                                               
      #|        │             │    │                                               
      #|        │             │    │                                               
      #|        │             │    │                                               
      #|        │             │    │                                               
      #|┌───────────────┐     │    │                                               
      #|│               │     │    │                                               
      #|│  shape: circ  │─────┘    │                                               
      #|│               │          │                                               
      #|└───────────────┘          │                                               
      #|        │                  │                                               
      #|        │                  │                                               
      #|        │                  │                                               
      #|        │                  │                                               
      #|        │                  │                                               
      #|┌───────────────┐          │                                               
      #|│               │          │                                               
      #|│  shape: circ  │          │                                               
      #|│               │          │                                               
      #|└───────────────┘          │                                               
      #|        │                  │                                               
      #|        │                  │                                               
      #|        │                  │                                               
      #|        │                  │                                               
      #|        │                  │                                               
      #|┌───────────────┐          │                                               
      #|│               │          │                                               
      #|│  shape: circ  │          │                                               
      #|│               │          │                                               
      #|└───────────────┘          │                                               
      #|        │                  │                                               
      #|        │                  │                                               
      #|        │                  │                                               
      #|        │                  │                                               
      #|        │                  │                                               
      #|┌───────┴───────┐          │                                               
      #|│               │          │                                               
      #|│ shape: f-circ │          │                                               
      #|│               │          │                                               
      #|└───────────────┘          │                                               
      #|        │                  │                                               
      #|        │                  │                                               
      #|        │                  │                                               
      #|        │                  │                                               
      #|        │                  │                                               
      #|┌───────────────┐          │                                               
      #|│               │          │                                               
      #|│      a-b      ├──────────┤                                               
      #|│               │          │                                               
      #|└───────────────┘          │                                               
      #|        │                  │                                               
      #|        │                  │                                               
      #|        │                  │                                               
      #|        │                  │                                               
      #|        │                  │                                               
      #|┌───────────────┐          │                                               
      #|│               │          │                                               
      #|│     1 -- c    ├──────────┘                                               
      #|│               │                                                          
      #|└───────────────┘                                                          
      #|        │                                                                  
      #|        │                                                                  
      #|        │                                                                  
      #|        │                                                                  
      #|        │                                                                  
      #|┌───────┴───────┐                                                          
      #|│               │                                                          
      #|│     2 -- d    │                                                          
      #|│               │                                                          
      #|└───────────────┘                                                          
    ),
  )
}

///|
test "NFA fixture 003: parallel paths with shared alphabet" {
  let input =
    #|graph LR
    #|0@{shape: circ}
    #|1@{shape: circ}
    #|2@{shape: circ}
    #|3@{shape: circ}
    #|4@{shape: circ}
    #|5@{shape: circ}
    #|6@{shape: circ}
    #|7@{shape: circ}
    #|8@{shape: circ}
    #|start@{shape: f-circ} --- 8
    #|0 -- A --> 1
    #|1 -- B --> 2
    #|2 -- C --> 3
    #|3 --- #0@{shape: dbl-circ}
    #|4 -- A --> 5
    #|5 -- B --> 6
    #|6 -- C --> 7
    #|7 --- #1@{shape: dbl-circ}
    #|8 -.-> 0
    #|8 -.-> 4
  inspect(
    inspect_nfa_ascii_and_unicode(input),
    content=(
      #|# ASCII
      #|+---------------+        +---+     +-----------------+
      #||               |        |   |     |                 |
      #||  shape: circ  |        | 8 |     | shape: dbl-circ |
      #||               |        |   |     |                 |
      #|+---------------+        +---+     +-----------------+
      #|                           ^                ^         
      #|                           |                |         
      #|                           |                |         
      #|                           |                |         
      #|                           |                |         
      #|+---------------+        +---+     +-----------------+
      #||               |        |   |     |                 |
      #||  shape: circ  |        | 1 |     | shape: dbl-circ |
      #||               |        |   |     |                 |
      #|+---------------+        +---+     +-----------------+
      #|                           ^                ^         
      #|                           |                |         
      #|                           |                |         
      #|                           |                |         
      #|                           |                |         
      #|+---------------+        +---+     +-----------------+
      #||               |        |   |     |                 |
      #||  shape: circ  |        | 2 |---->|        0        |
      #||               |        |   |     |                 |
      #|+---------------+        +---+     +-----------------+
      #|                           ^                |         
      #|                           |                |         
      #|                           |                |         
      #|                           |                |         
      #|                           |                |         
      #|+---------------+        +---+     +-----------------+
      #||               |        |   |     |                 |
      #||  shape: circ  |        | 3 |---->|        4        |
      #||               |        |   |     |                 |
      #|+---------------+        +---+     +-----------------+
      #|                           ^                |         
      #|                           |                |         
      #|                           |                |         
      #|                           |                |         
      #|                           |                |         
      #|+---------------+        +---+              |         
      #||               |        |   |              |         
      #||  shape: circ  |        | 5 |              |         
      #||               |        |   |              |         
      #|+---------------+        +---+              |         
      #|                           ^                |         
      #|                           |                |         
      #|                           |                |         
      #|                           |                |         
      #|                           |                |         
      #|+---------------+        +---+              |         
      #||               |        |   |              |         
      #||  shape: circ  |        | 6 |              |         
      #||               |        |   |              |         
      #|+---------------+        +---+              |         
      #|                           ^                |         
      #|                           |                |         
      #|                           |                |         
      #|                           |                |         
      #|                           |                |         
      #|+---------------+        +---+              |         
      #||               |        |   |              |         
      #||  shape: circ  |        | 7 |--------------+         
      #||               |        |   |                        
      #|+---------------+        +---+                        
      #|                           ^                          
      #|                           |                          
      #|                           |                          
      #|                           |                          
      #|                           |                          
      #|+---------------+          |                          
      #||               |          |                          
      #||  shape: circ  |          |                          
      #||               |          |                          
      #|+---------------+          |                          
      #|                           |                          
      #|                           |                          
      #|                           |                          
      #|                           |                          
      #|                           |                          
      #|+---------------+          |                          
      #||               |          |                          
      #||  shape: circ  |          |                          
      #||               |          |                          
      #|+---------------+          |                          
      #|                           |                          
      #|                           |                          
      #|                           |                          
      #|                           |                          
      #|                           |                          
      #|+---------------+          |                          
      #||               |          |                          
      #|| shape: f-circ |----------+                          
      #||               |          |                          
      #|+---------------+          |                          
      #|                           |                          
      #|                           |                          
      #|                           |                          
      #|                           |                          
      #|                           |                          
      #|+---------------+          |                          
      #||               |          |                          
      #||     0 -- A    |----------+                          
      #||               |          |                          
      #|+---------------+          |                          
      #|                           |                          
      #|                           |                          
      #|                           |                          
      #|                           |                          
      #|                           |                          
      #|+---------------+          |                          
      #||               |          |                          
      #||     1 -- B    |----------+                          
      #||               |          |                          
      #|+---------------+          |                          
      #|                           |                          
      #|                           |                          
      #|                           |                          
      #|                           |                          
      #|                           |                          
      #|+---------------+          |                          
      #||               |          |                          
      #||     2 -- C    |----------+                          
      #||               |          |                          
      #|+---------------+          |                          
      #|                           |                          
      #|                           |                          
      #|                           |                          
      #|                           |                          
      #|                           |                          
      #|+---------------+          |                          
      #||               |          |                          
      #||     4 -- A    |----------+                          
      #||               |          |                          
      #|+---------------+          |                          
      #|                           |                          
      #|                           |                          
      #|                           |                          
      #|                           |                          
      #|                           |                          
      #|+---------------+          |                          
      #||               |          |                          
      #||     5 -- B    |----------+                          
      #||               |          |                          
      #|+---------------+          |                          
      #|                           |                          
      #|                           |                          
      #|                           |                          
      #|                           |                          
      #|                           |                          
      #|+---------------+          |                          
      #||               |          |                          
      #||     6 -- C    |----------+                          
      #||               |                                     
      #|+---------------+                                     
      #|
      #|# UNICODE
      #|┌───────────────┐        ┌───┐     ┌─────────────────┐
      #|│               │        │   │     │                 │
      #|│  shape: circ  │        │ 8 │     │ shape: dbl-circ │
      #|│               │        │   │     │                 │
      #|└───────────────┘        └─┬─┘     └─────────────────┘
      #|                           ▲                ▲         
      #|                           │                │         
      #|                           │                │         
      #|                           │                │         
      #|                           │                │         
      #|┌───────────────┐        ┌───┐     ┌─────────────────┐
      #|│               │        │   │     │                 │
      #|│  shape: circ  │        │ 1 │     │ shape: dbl-circ │
      #|│               │        │   │     │                 │
      #|└───────────────┘        └───┘     └─────────────────┘
      #|                           ▲                ▲         
      #|                           │                │         
      #|                           │                │         
      #|                           │                │         
      #|                           │                │         
      #|┌───────────────┐        ┌───┐     ┌─────────────────┐
      #|│               │        │   │     │                 │
      #|│  shape: circ  │        │ 2 │────►│        0        │
      #|│               │        │   │     │                 │
      #|└───────────────┘        └───┘     └─────────────────┘
      #|                           ▲                │         
      #|                           │                │         
      #|                           │                │         
      #|                           │                │         
      #|                           │                │         
      #|┌───────────────┐        ┌───┐     ┌─────────────────┐
      #|│               │        │   │     │                 │
      #|│  shape: circ  │        │ 3 ├────►│        4        │
      #|│               │        │   │     │                 │
      #|└───────────────┘        └───┘     └─────────────────┘
      #|                           ▲                │         
      #|                           │                │         
      #|                           │                │         
      #|                           │                │         
      #|                           │                │         
      #|┌───────────────┐        ┌───┐              │         
      #|│               │        │   │              │         
      #|│  shape: circ  │        │ 5 │              │         
      #|│               │        │   │              │         
      #|└───────────────┘        └───┘              │         
      #|                           ▲                │         
      #|                           │                │         
      #|                           │                │         
      #|                           │                │         
      #|                           │                │         
      #|┌───────────────┐        ┌───┐              │         
      #|│               │        │   │              │         
      #|│  shape: circ  │        │ 6 │              │         
      #|│               │        │   │              │         
      #|└───────────────┘        └───┘              │         
      #|                           ▲                │         
      #|                           │                │         
      #|                           │                │         
      #|                           │                │         
      #|                           │                │         
      #|┌───────────────┐        ┌───┐              │         
      #|│               │        │   │              │         
      #|│  shape: circ  │        │ 7 ├──────────────┘         
      #|│               │        │   │                        
      #|└───────────────┘        └───┘                        
      #|                           ▲                          
      #|                           │                          
      #|                           │                          
      #|                           │                          
      #|                           │                          
      #|┌───────────────┐          │                          
      #|│               │          │                          
      #|│  shape: circ  │          │                          
      #|│               │          │                          
      #|└───────────────┘          │                          
      #|                           │                          
      #|                           │                          
      #|                           │                          
      #|                           │                          
      #|                           │                          
      #|┌───────────────┐          │                          
      #|│               │          │                          
      #|│  shape: circ  │          │                          
      #|│               │          │                          
      #|└───────────────┘          │                          
      #|                           │                          
      #|                           │                          
      #|                           │                          
      #|                           │                          
      #|                           │                          
      #|┌───────────────┐          │                          
      #|│               │          │                          
      #|│ shape: f-circ ├──────────┤                          
      #|│               │          │                          
      #|└───────────────┘          │                          
      #|                           │                          
      #|                           │                          
      #|                           │                          
      #|                           │                          
      #|                           │                          
      #|┌───────────────┐          │                          
      #|│               │          │                          
      #|│     0 -- A    ├──────────┤                          
      #|│               │          │                          
      #|└───────────────┘          │                          
      #|                           │                          
      #|                           │                          
      #|                           │                          
      #|                           │                          
      #|                           │                          
      #|┌───────────────┐          │                          
      #|│               │          │                          
      #|│     1 -- B    ├──────────┤                          
      #|│               │          │                          
      #|└───────────────┘          │                          
      #|                           │                          
      #|                           │                          
      #|                           │                          
      #|                           │                          
      #|                           │                          
      #|┌───────────────┐          │                          
      #|│               │          │                          
      #|│     2 -- C    ├──────────┤                          
      #|│               │          │                          
      #|└───────────────┘          │                          
      #|                           │                          
      #|                           │                          
      #|                           │                          
      #|                           │                          
      #|                           │                          
      #|┌───────────────┐          │                          
      #|│               │          │                          
      #|│     4 -- A    ├──────────┤                          
      #|│               │          │                          
      #|└───────────────┘          │                          
      #|                           │                          
      #|                           │                          
      #|                           │                          
      #|                           │                          
      #|                           │                          
      #|┌───────────────┐          │                          
      #|│               │          │                          
      #|│     5 -- B    ├──────────┤                          
      #|│               │          │                          
      #|└───────────────┘          │                          
      #|                           │                          
      #|                           │                          
      #|                           │                          
      #|                           │                          
      #|                           │                          
      #|┌───────────────┐          │                          
      #|│               │          │                          
      #|│     6 -- C    ├──────────┘                          
      #|│               │                                     
      #|└───────────────┘                                     
    ),
  )
}

///|
test "NFA fixture 001: SVG renders all nodes and edges" (it : @test.Test) {
  let input =
    #|graph LR
    #|0@{shape: circ}
    #|1@{shape: circ}
    #|2@{shape: circ}
    #|3@{shape: circ}
    #|4@{shape: circ}
    #|5@{shape: circ}
    #|start@{shape: f-circ} --- 0
    #|0 -- [a-b] --> 3
    #|1 -- c --> 2
    #|2 -- d --> 4
    #|3 -.-> 1
    #|3 -.-> 4
    #|4 -.-> 0
    #|4 -.-> 5
    #|5 --- #0@{shape: dbl-circ}
  let svg = @beautiful_mermaid.render_mermaid(input)
  it.write(svg)
  it.snapshot(filename="nfa_001_svg.svg")
}

///|
test "NFA fixture 003: SVG renders all nodes and edges" (it : @test.Test) {
  let input =
    #|graph LR
    #|0@{shape: circ}
    #|1@{shape: circ}
    #|2@{shape: circ}
    #|3@{shape: circ}
    #|4@{shape: circ}
    #|5@{shape: circ}
    #|6@{shape: circ}
    #|7@{shape: circ}
    #|8@{shape: circ}
    #|start@{shape: f-circ} --- 8
    #|0 -- A --> 1
    #|1 -- B --> 2
    #|2 -- C --> 3
    #|3 --- #0@{shape: dbl-circ}
    #|4 -- A --> 5
    #|5 -- B --> 6
    #|6 -- C --> 7
    #|7 --- #1@{shape: dbl-circ}
    #|8 -.-> 0
    #|8 -.-> 4
  let svg = @beautiful_mermaid.render_mermaid(input)
  it.write(svg)
  it.snapshot(filename="nfa_003_svg.svg")
}
